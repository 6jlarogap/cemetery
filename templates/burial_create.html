{% extends "base.html" %}
{% load adminmedia %}
{% load my_filters %}

{% block title %}Ввод данных{% endblock %}

{% block content %}
    <div class="row-fluid">
        <div class="span3">
            <form class='form-horizontal main-add' method="POST">
                <div class="well">
                    <div class="row-fluid">
                        <h2>Захоронение</h2>
                        <p>
                            {{ burial_form.account_number.label_tag }}
                            {{ burial_form.account_number }}
                            {{ burial_form.account_number.errors }}
                        </p>
                        <p class="narrow">
                            {{ burial_form.operation.label_tag }}
                            {{ burial_form.operation }}
                            {{ burial_form.operation.errors }}
                        </p>
                        <p class="narrow">
                            {{ burial_form.date_fact.label_tag }}
                            {{ burial_form.date_fact }}
                            {{ burial_form.date_fact.errors }}
                        </p>
                    </div><!--/.well -->
                    <div class="row-fluid">
                        <h2>Место</h2>
                        {{ burial_form.place }}
                        {% if burial_form.instance.place.pk %}
                            <a href="{% url new_burial_place %}?instance={{ burial_form.instance.place.pk }}" class="load link-place">
                                {{ burial_form.instance.place }}
                            </a>
                        {% else %}
                            <a href="{% url new_burial_place %}" class="load link-place">Новое</a>
                        {% endif %}

                        <br/>
                        <b>Ответственный: </b>

                        {{ burial_form.responsible }}
                        {% if burial_form.instance.place.responsible.pk %}
                            <a href="{% url new_burial_responsible %}?instance={{ burial_form.instance.place.responsible.pk }}" class="load link-responsible">
                                {{ burial_form.instance.place.responsible }}
                            </a>
                        {% else %}
                            <a href="{% url new_burial_responsible %}" class="load link-responsible">Новый</a>
                        {% endif %}

                        <h2>Усопший</h2>
                        {{ burial_form.person }}
                        {% if burial_form.instance.person.pk %}
                            <a href="{% url new_burial_person %}?instance={{ burial_form.instance.person.pk }}" class="load link-person">
                                {{ burial_form.instance.person }}
                            </a>
                        {% else %}
                            <a href="{% url new_burial_person %}" class="load link-person">Новый</a>
                        {% endif %}
                        <h2>Заказчик</h2>
                        {{ burial_form.client_person }}
                        {{ burial_form.client_organization }}
                        {{ burial_form.agent }}
                        {{ burial_form.doverennost }}
                        {% if burial_form.instance.client_person.pk %}
                            <a href="{% url new_burial_customer %}?instance={{ burial_form.instance.client_person.pk }}&customer_type=0" class="load link-customer">
                                ФЛ {{ burial_form.instance.client_person }}
                            </a>
                        {% endif %}
                        {% if burial_form.instance.client_organization.pk %}
                            <a href="{% url new_burial_customer %}?customer_type=1&agent_director={% if burial_form.instance.agent %}{% else %}1{% endif %}&organization={{ burial_form.instance.client_organization.pk }}" class="load link-customer">
                                ЮЛ {{ burial_form.instance.client_organization }}
                            </a>
                        {% endif %}
                        {% if not burial_form.instance.client_person.pk and not burial_form.instance.client_organization.pk %}
                            <a href="{% url new_burial_customer %}" class="load link-customer">Новый</a>
                        {% endif %}
                        <h2 class="buttons">
                            <button class="btn btn-primary btn-large" disabled="disabled">Сохранить</button>
                        </h2>
                    </div><!--/.well -->
                </div>
            </form>
        </div><!--/span-->
        <div id="block_empty" class="block-selectable span9">
            <div class="well">
                <h2>Не выбрано</h2>
                <p>Выберите данные для редактирования слева. Пока данные не заполнены, сохранить захоронение не получится.</p>
            </div><!--/.well -->
        </div>
    </div>
    <div class="row-fluid">
        <div class="span12">
            <div class="row-fluid">
                <h2>Последние введенные</h2>
                <table class="table table-striped table-bordered">
                    <thead>
                        <th>№ в кн</th>
                        <th>ФИО</th>
                        <th>Дата захор</th>
                        <th>Уч</th>
                        <th>Ряд</th>
                        <th>Мог</th>
                        <th>Кладб</th>
                        <th>Услуга</th>
                        <th>Заказчик</th>
                        <th>Опции</th>
                    </thead>
                    {% for b in last_entered %}
                        <tr>
                            <td>{{ b.account_number }}</td>
                            <td>
                                <b> {{ b.person.last_name }}</b>
                                {{ b.person.first_name }}
                                {{ b.person.patronymic }}
                            </td>
                            <td>{{ b.date_fact|date:"d.m.Y" }}</td>
                            <td>{{ b.place.area }}</td>
                            <td>{{ b.place.row }}</td>
                            <td>{{ b.place.seat }}</td>
                            <td>{{ b.place.cemetery.name }}</td>
                            <td>{{ b.operation.op_type }}</td>
                            {% if b.client_organization %}
                                <td>
                                    ЮЛ {{ b.client_organization }}<br/>
                                    {% if b.agent %}{{ b.agent }}{% else %}{{ b.client_organization.ceo|default:"" }}{% endif %}
                                </td>
                            {% else %}
                                <td>
                                    ФЛ {{ b.client_person }}
                                </td>
                            {% endif %}
                            <td>
                                {% if b.orderfiles_set.count %}
                                    <small><a title="файл прикреплен"><i class="icon icon-file"></i></a></small>
                                {% endif %}
                                {% if user|in_group:"edit_burial"  %}
                                    <a title="редактировать" target="_blank" href='{% url edit_burial b.pk %}'><i class="icon-edit"></i> редактировать</a>
                                {% endif %}
                                <a title="к могиле" href="#"><i class="icon icon-map-marker"></i> к могиле</a>
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
{% endblock %}

