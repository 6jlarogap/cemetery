{% extends "base.html" %}
{% load adminmedia %}
{% load my_filters %}
{% block scripts %}
    {{ form.media }}
    <link rel="stylesheet" href="/media/css/ui-lightness/jquery-ui-1.8.6.custom.css" type="text/css" />
    <link rel="stylesheet" href="/media/css/jquery-ui-timepicker.css?v=0.2.3" type="text/css" />

    <script type="text/javascript" src="/media/js/jquery-ui-1.8.6.custom.min.js"></script>
    <script type="text/javascript" src="/media/js/jquery.query-2.1.7.js"></script>
    <script type="text/javascript" src="/admin_media/js/admin/RelatedObjectLookups.js"></script>
    <script type="text/javascript" src="/media/js/jquery.ui.timepicker.js?v=0.2.3"></script>
    <script type="text/javascript" src="/media/js/jquery.query-2.1.7.js"></script>
    <script type="text/javascript" src="/media/js/jquery.autocomplete.min.js"></script>
    <script type="text/javascript" src="/media/js/jquery.bgiframe.min.js"></script>
    <link rel="stylesheet" href="/media/css/jquery.autocomplete.css" type="text/css" />
    <script type="text/javascript">
        window.__admin_media_prefix__ = "{% filter escapejs %}{% admin_media_prefix %}{% endfilter %}";
    </script>
    <script type="text/javascript">
        var submit_form = function()
        {
            $("#mainform").submit();
        }
    </script>
    <script>
        $(function(){
            //Фокус в нужное поле.
            $("#id_fio").focus();

            //автодополнение фамилии заказчика.
            $("#id_customer").autocomplete("/getpersonunln/", {
//            autoFill: true,
//            matchContains: true,
                minChars: 1,
//            cacheLength: 1,
                selectFirst: false,
                max: 16
            });

            //автодополнение фамилии захороненного.
            $("#id_fio").autocomplete("/getdeadman/", {
//        autoFill: true,
//        matchContains: true,
                minChars: 1,
//        extraParams: {
//            region: function(){
//                return $("#id_default_region").val();
//            }
//        },
//        cacheLength: 1,
                selectFirst: false,
//        selectOnly: true,
//        highlight: false,
                max: 16
            });

            $('input[name=print]').click(function() {
                $('#mainform').attr('target', '_blank');
                window.setTimeout("$('#mainform').attr('target', '');", 100);
            });

            var CALENDAR_ICON = '/admin_media/img/admin/icon_calendar.gif';
            var CLOCK_IMAGE = '/admin_media/img/admin/icon_clock.gif';

            $.datepicker.setDefaults($.datepicker.regional['']);
            var now = Date();
            $('input[name*=date],input[name*=expire],input[name*=when]').css('width', '75px').datepicker({
                dateFormat: 'dd.mm.yy',
                changeMonth: true,
                changeYear: true,
                yearRange: '1900:' + now.year,
                firstDay: 1,
                monthNamesShort: ['Янв','Фев','Март','Апрель','Май','Июнь','Июль','Авг','Сен','Окт','Ноя','Дек'],
                dayNamesMin: ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'],
                showOn: "both",
                buttonImage: CALENDAR_ICON,
                buttonImageOnly: true
            });
            $('input[name*=time]').each(function() {
                var btn_id = $(this).attr('id') + '_button';
                var img = $('<img src="'+CLOCK_IMAGE+'"/>').attr('id', btn_id).insertAfter($(this));
                $(this).css('width', '75px').timepicker({
                    showOn: "both",
                    button: "#" + btn_id,
                    hourText: 'Ч',
                    minuteText: 'М',
                    showPeriodLabels: false,
                    minutes: {
                        starts: 0,
                        ends: 45,
                        interval: 15
                    },
                    hours: {
                        starts: 8,
                        ends: 19,
                        interval: 1
                    }
                });
            });

            $(':input,textarea,select').each(function(i, el) {
                $(el).attr('tabIndex', i+1);
            });

            $('.block-selectable').hide();

            $('.well li a').click(function() {
                var id = $(this).attr('href');
                $('.block-selectable').hide();
                $('.block-selectable').filter(id).fadeIn();
                return false;
            });
        })

    </script>
{% endblock %}



{% block title %}Поиск{% endblock %}
{% block content %}
    <div class="row-fluid">
        <form class='form-horizontal'>
            <div class="span3">
                <div class="well">
                    <div class="row-fluid">
                        <h2>Захоронение</h2>
                        {{ burial_form.as_p }}
                    </div><!--/.well -->
                    <div class="row-fluid">
                        <h2>Место</h2>
                        {{ place_form.as_p }}
                    </div><!--/.well -->
                </div>
            </div><!--/span-->
            <div class="span2">
                <div class="well">
                    <ul class="nav nav-list">
                        <li><a href="#block_dead"><i class="icon-ok"></i> Усопший</a></li>
                        <li><a href="#block_customer"><i class="icon-pencil"></i> Заказчик</a></li>
                        <li><a href="#block_responsible"><i class="icon-warning-sign"></i> Ответственный</a></li>
                    </ul>
                </div><!--/.well -->
            </div><!--/span-->
            <div id="block_dead" class="block-selectable span7">
                <div class="well">
                    <h2>Усопший</h2>
                    {{ person_form.as_p }}
                    <h2>Адрес</h2>
                    {{ location_form.as_p }}
                </div><!--/.well -->
            </div>
            <div id="block_customer" class="block-selectable span7">
                <div class="well">
                    <h2>Заказчик</h2>
                    {{ person_form.as_p }}
                    <h2>Адрес</h2>
                    {{ location_form_customer.as_p }}
                </div><!--/.well -->
            </div>
            <div id="block_responsible" class="block-selectable span7">
                <div class="well">
                    <h2>Ответственный</h2>
                    {{ person_form.as_p }}
                    <h2>Адрес</h2>
                    {{ location_form_responsible.as_p }}
                </div><!--/.well -->
            </div>
        </form>
    </div>
    <div class="row-fluid">
        <div class="span12">
            <div class="row-fluid">
                <h2>Последние введенные</h2>
                <table class="table table-striped table-bordered">
                    <thead>
                        <th>№ в кн</th>
                        <th>ФИО</th>
                        <th>Дата захор</th>
                        <th>Уч</th>
                        <th>Ряд</th>
                        <th>Мог</th>
                        <th>Кладб</th>
                        <th>Услуга</th>
                        <th>Заказчик</th>
                        <th>Опции</th>
                    </thead>
                    {% for b in object_list %}
                        <tr>
                            <td>{{ b.account_book_n }}</td>
                            <td>
                                <b> {{ b.person.last_name }}</b>
                                {{ b.person.first_name }}
                                {{ b.person.patronymic }}
                            </td>
                            <td>{{ b.date_fact|date:"d.m.Y" }}</td>
                            <td>{{ b.product.place.area }}</td>
                            <td>{{ b.product.place.row }}</td>
                            <td>{{ b.product.place.seat }}</td>
                            <td>{{ b.product.place.cemetery.name }}</td>
                            <td>{{ b.operation.op_type }}</td>
                            {% if b.organization %}
                                <td>
                                    {{ b.organization }}<br/>
                                    {% if b.responsible_agent %}{{ b.responsible_agent.person }}{% else %}{{ b.ceo_name }}{% endif %}
                                </td>
                            {% else %}
                                <td>
                                    {{ b.customer.person.last_name }}
                                    {{ b.customer.person.first_name }}
                                    {{ b.customer.person.patronymic }}
                                </td>
                            {% endif %}
                            <td>
                                {% if b.orderfiles_set.count %}
                                    <small><a title="файл прикреплен">f</a></small>
                                {% endif %}
                                {% if user|in_group:"edit_burial"  %}
                                    <a title="редактировать" target="_blank" href='/burial/{{ b.uuid }}/'><img src="/media/edit.png"></a>
                                {% endif %}
                                <a title="к могиле"
                                   href='/?cemetery={{ b.product.place.cemetery.uuid }}&area={{ b.product.place.area|default:'NULL' }}&row={{ b.product.place.row|default:'NULL' }}&seat={{ b.product.place.seat|default:'NULL' }}'
                                        ><img width="16" src="/media/tree.png"></a>
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
{% endblock %}
