{% extends "base.html" %}
{% load adminmedia %}
{% load my_filters %}

{% block title %}Ввод данных{% endblock %}

{% block content %}
    {% if burial_form.duplicates_found %}
        <div class="row-fluid">
            <table class="burials table table-striped table-bordered">
                <thead>
                <th>№ в книге</th>
                <th>ФИО</th>
                <th>Дата захоронения</th>
                <th>Участок</th>
                <th>Ряд</th>
                <th>Могила</th>
                <th>Кладбище</th>
                <th>Услуга</th>
                <th>Заказчик</th>
                <th>Телефон</th>
                <th>Комментарий</th>
                <th>Опции</th>
                </thead>
                {% for b in burial_form.duplicates_list %}
                    <tr>
                        <td>{{ b.account_number }}</td>
                        <td>
                            <b> {{ b.person.last_name }}</b>
                            {{ b.person.first_name }}
                            {{ b.person.middle_name }}
                        </td>
                        <td>{{ b.date_fact|date:"d.m.Y" }}</td>
                        <td>{{ b.place.area }}</td>
                        <td>{{ b.place.row }}</td>
                        <td>{{ b.place.seat }}</td>
                        <td>{{ b.place.cemetery.name }}</td>
                        <td>{{ b.operation.op_type }}</td>
                        <td>
                            {% if b.client_organization %}
                                ЮЛ {{ b.client_organization }}<br/>
                                {% if b.agent %}{{ b.agent.person }}{% else %}{{ b.client_organization.ceo|default:"" }}{% endif %}
                            {% else %}
                                {% if b.client_person %}
                                    ФЛ {{ b.client_person }}
                                {% else %}
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            {% if b.client_organization %}
                                {{ b.client_organization.phones|default:"" }}
                            {% endif %}
                            {% if b.client_person %}
                                {{ b.client_person.phones|default:"" }}
                            {% endif %}
                        </td>
                        <td>
                            {% for comment in b.ordercomments_set.all %}
                                {{ comment.comment }}
                            {% endfor %}
                        </td>
                        <td>
                            {% if b.orderfiles_set.count %}
                                <small><a title="файл прикреплен"><i class="icon icon-file"></i></a></small>
                            {% endif %}
                            {% if user|in_group:"edit_burial"  %}
                                <a title="редактировать" target="_blank" href='{% url edit_burial b.pk %}'><i class="icon icon-edit"></i></a>
                            {% endif %}
                            <a title="карточка" href="{% url view_burial b.pk %}"><i class="icon icon-list"></i></a>
                            <a title="к могиле" href="{% url view_place b.place.pk %}"><i class="icon icon-map-marker"></i></a>
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    {% endif %}
    <div class="row-fluid">
        <div class="span3">
            <form class='form-horizontal main-add' method="POST">
                <div class="well">
                    {{ burial_form.non_field_errors }}
                    {% if burial_form.duplicates_found %}
                        <p>{{ burial_form.allow_duplicates.label_tag }}</p>
                        <p>{{ burial_form.allow_duplicates }}</p>
                    {% endif %}
                    <div class="row-fluid">
                        <h2>Захоронение</h2>
                        {% if burial_form.instance.pk %}
                            <div><a href="{% url view_burial burial_form.instance.pk %}" target="_blank">Карточка</a></div>
                            <div id="place_link"><a href="{% url view_place burial_form.instance.place.pk %}" target="_blank">Карточка места</a></div>
                        {% else %}
                            <div id="top_place_link"></div>
                        {% endif %}
                        <p>
                            {{ burial_form.account_number.label_tag }}
                            {{ burial_form.account_number }}
                            {{ burial_form.account_number.errors }}
                        </p>
                        <p class="narrow">
                            {{ burial_form.operation.label_tag }}
                            {{ burial_form.operation }}
                            {{ burial_form.operation.errors }}
                        </p>
                        <p class="narrow">
                            {{ burial_form.date_fact.label_tag }}
                            {{ burial_form.date_fact }}
                            {{ burial_form.time_fact }}
                            {{ burial_form.date_fact.errors }}
                            {{ burial_form.time_fact.errors }}
                        </p>
                        {% if burial_form.instance.pk %}
                            <div>
                                <a id="show_exhumation" class="btn">Эксгумация</a>
                            </div>
                            <p class="narrow" id="exhumation_block">
                                {{ burial_form.exhumated_date.label_tag }}
                                {{ burial_form.exhumated_date }}
                                {{ burial_form.exhumated_date.errors }}
                                <a id="clean_exhumation" class="btn">очистить</a>
                            </p>
                        {% endif %}
                    </div><!--/.well -->
                    <div class="row-fluid">
                        <h2>Усопший*</h2>
                        {{ burial_form.person }}
                        {% if burial_form.instance.person.pk %}
                            <a href="{% url new_burial_person %}?instance={{ burial_form.instance.person.pk }}&dead=1" class="load link-person">
                                {{ burial_form.instance.person }}
                            </a>
                            <script type="text/javascript">
                                $(function() {
                                    $('.load.link-person').click();
                                });
                            </script>
                        {% else %}
                            <a href="{% url new_burial_person %}?dead=1" class="load link-person">Новый</a>
                        {% endif %}

                        <h2>Место*</h2>
                        {{ burial_form.place }}
                        {% if burial_form.instance.place.pk %}
                            <a href="{% url new_burial_place %}?instance={{ burial_form.instance.place.pk }}" class="load link-place">
                                {{ burial_form.instance.place }}
                            </a>
                        {% else %}
                            <a href="{% url new_burial_place %}" class="load link-place">Новое</a>
                        {% endif %}

                        <br/>
                        <b>Ответственный: </b>

                        {{ burial_form.responsible }}
                        {% if burial_form.instance.place.responsible.pk %}
                            <a href="{% url new_burial_responsible %}?instance={{ burial_form.instance.place.responsible.pk }}" class="load link-responsible">
                                {{ burial_form.instance.place.responsible }}
                            </a>
                        {% else %}
                            {% if burial_form.instance.place.pk %}
                                <a href="{% url new_burial_responsible %}" class="load link-responsible">Новый</a>
                            {% else %}
                                <a href="{% url new_burial_responsible %}" class="load link-responsible"></a>
                            {% endif %}
                        {% endif %}
                        <br/>
                        <a href="#" id="copy_responsible_to_client">Тот же Заказчик</a>

                        <h2>Заказчик*</h2>
                        {{ burial_form.client_person }}
                        {{ burial_form.client_organization }}
                        {{ burial_form.agent }}
                        {{ burial_form.doverennost }}
                        {% if burial_form.instance.client_organization.pk %}
                            <a href="{% url new_burial_customer %}?customer_type=1&agent_person={{ burial_form.instance.agent.person.pk }}&agent_director={% if burial_form.instance.agent_director  %}1{% endif %}&organization={{ burial_form.instance.client_organization.pk }}" class="load link-customer">
                                ЮЛ {{ burial_form.instance.client_organization }}
                            </a>
                        {% else %}
                            {% if burial_form.instance.client_person.pk %}
                                <a href="{% url new_burial_customer %}?instance={{ burial_form.instance.client_person.pk }}&customer_type=0" class="load link-customer">
                                    {% if burial_form.instance.client_person == burial_form.instance.place.responsible %}
                                        Отв.
                                    {% else %}
                                        ФЛ
                                    {% endif %}
                                    {{ burial_form.instance.client_person }}
                                </a>
                            {% endif %}
                        {% endif %}
                        {% if not burial_form.instance.client_person.pk and not burial_form.instance.client_organization.pk %}
                            <a href="{% url new_burial_customer %}" class="load link-customer">Новый</a>
                        {% endif %}
                        <h2 class="buttons">
                            <button class="btn btn-primary btn-large" disabled="disabled">Сохранить</button>
                            {% block buttons %}
                            {% endblock %}
                        </h2>
                    </div><!--/.well -->
                </div>
            </form>
        </div><!--/span-->
        <div id="block_empty" class="block-selectable span9">
            <div class="well">
                <h2>Не выбрано</h2>
                <p>Выберите данные для редактирования слева. Пока данные не заполнены, сохранить захоронение не получится.</p>
            </div><!--/.well -->
        </div>
    </div>
    <div class="row-fluid">
        <div class="span12">
            <div class="row-fluid">
                <h2>Последние введенные</h2>
                <table class="table table-striped table-bordered">
                    <thead>
                        <th>№ в книге</th>
                        <th>ФИО</th>
                        <th>Дата захоронения</th>
                        <th>Участок</th>
                        <th>Ряд</th>
                        <th>Могила</th>
                        <th>Кладбище</th>
                        <th>Услуга</th>
                        <th>Заказчик</th>
                        <th>Опции</th>
                    </thead>
                    {% for b in last_entered %}
                        <tr>
                            <td>{{ b.account_number }}</td>
                            <td>
                                <b> {{ b.person.last_name }}</b>
                                {{ b.person.first_name }}
                                {{ b.person.middle_name }}
                            </td>
                            <td>{{ b.date_fact|date:"d.m.Y" }}</td>
                            <td>{{ b.place.area }}</td>
                            <td>{{ b.place.row }}</td>
                            <td>{{ b.place.seat }}</td>
                            <td>{{ b.place.cemetery.name }}</td>
                            <td>{{ b.operation.op_type }}</td>
                            <td>
                                {% if b.client_organization %}
                                    ЮЛ {{ b.client_organization }}<br/>
                                    {% if b.agent %}{{ b.agent.person }}{% else %}{{ b.client_organization.ceo|default:"" }}{% endif %}
                                {% else %}
                                    {% if b.client_person %}
                                        ФЛ {{ b.client_person }}
                                    {% else %}
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                {% if b.orderfiles_set.count %}
                                    <small><a title="файл прикреплен"><i class="icon icon-file"></i></a></small>
                                {% endif %}
                                {% if user|in_group:"edit_burial"  %}
                                    <a title="редактировать" target="_blank" href='{% url edit_burial b.pk %}'><i class="icon icon-edit"></i></a>
                                {% endif %}
                                <a title="карточка" href="{% url view_burial b.pk %}"><i class="icon icon-list"></i></a>
                                <a title="к могиле" href="{% url view_place b.place.pk %}"><i class="icon icon-map-marker"></i></a>
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
{% endblock %}

